<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link href='https://fonts.googleapis.com/css?family=Lato:300,900' rel='stylesheet' type='text/css'>

    <style>
        body {
            background-color: white;
        }
        
         :root {
            --line-chart-color: #607D8B;
            --annotation-context-color: #00796B;
            --annotation-above-color: #00BFA5;
            --annotation-anomaly-color: #E8336D;
            --annotation-america-color: #FE9733;
            --annotation-asia-color: #AB70B5;
            --annotation-oceania-color: #6FBE6E;
            --annotation-europe-color: #377EB8;
            --annotation-africa-color: rgb(228, 26, 28);
        }
        
        svg {
            background-color: white;
            font-size: 13px;
        }
        
        .axis,
        .axis text {
            fill: var(--line-chart-color);
        }
        
        .axis line,
        path {
            stroke: var(--line-chart-color);
        }
        
        path {
            fill: none;
        }
        
        .annotation path {
            stroke: var(--annotation-context-color);
        }
        
        .annotation:not(.above):not(.anomaly) path {
            stroke-dasharray: 1, 3;
        }
        
        .annotation text {
            fill: var(--annotation-context-color);
        }
        
        .annotation.europe text {
            fill: var(--annotation-europe-color);
        }
        
        .annotation.africa text {
            fill: var(--annotation-africa-color);
        }
        
        .annotation.oceania text {
            fill: var(--annotation-oceania-color);
        }
        
        .annotation.asia text {
            fill: var(--annotation-asia-color);
        }
        
        .annotation.above path {
            stroke: var(--annotation-above-color);
        }
        
        .annotation.above text {
            fill: var(--annotation-above-color);
        }
        
        .annotation.anomaly path {
            stroke: var(--annotation-anomaly-color);
            stroke-width: 2px;
        }
        
        .annotation.anomaly text {
            fill: var(--annotation-anomaly-color);
        }
        
        .annotation-note-bg {
            fill: rgba(0, 0, 0, 0);
        }
        
        .annotation-note-title {
            font-weight: bold;
        }
        
        text.title {
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdn.rawgit.com/susielu/d3-annotation/75ff6169/d3-annotation.js"></script>

</head>

<body>
    <div id="journeyChildDiv" style="width:600; height: 400;"></div>


    <script>
        const width = 600;
        const height = 400;
        const margin = {
            top: 50,
            bottom: 50,
            left: 50,
            right: 50
        }

        const x = d3.scaleTime().range([margin.left, width - margin.right])
            .domain([new Date('01/01/1981'), new Date('1/1/2020')])
        const y = d3.scaleLinear().range([height - margin.bottom, margin.top])
            .domain([4731, 260457])

        d3.csv("assets/data/acct_count-1.csv", function(error, json) {
            if (error) throw error;

            var line = d3.line()
                .x(function(d) {
                    return x(new Date(d.Date))
                })
                .y(function(d) {
                    return y(d.Close)
                })

            /* --- creating line using divided line code --- */
            var dLineData = dividedLine(parameters, json, 20);

            const svgLineChart = d3.select("#journeyChildDiv")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("position", "relative");

            svgLineChart.append('g')
                .attr('class', 'lineChart')

            svgLineChart.select("g.lineChart")
                .selectAll("path.segment")
                .data(dLineData)
                .enter()
                .append("path")
                .attr("d", function(d) {
                    return line(d.points)
                })
                .each(function(d) {
                    const styles = styleMap[d.key]
                    Object.keys(styles).forEach(function(k) {
                        d3.select(this)
                            .style(k, styles[k])
                    }, this)
                })


            svgLineChart.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Clients")
                .attr("class", "y axis label");

            var colorFn = d3.scaleOrdinal().domain(["Africa", "Europe", "Oceania", "Asia", "Americas"]).range([0, 250]);
            const yAxis = d3.axisLeft(y).ticks(5).tickFormat(d3.format(".2s"))
            const xAxis = d3.axisBottom(x)
            svgLineChart.append("g")
                .attr("class", "axis y")
                .attr("transform", "translate(" + margin.left + ", 0)")
                .call(yAxis);
            svgLineChart.append("g")
                .attr("class", "axis x")
                .attr("transform", "translate(0," + (height - margin.bottom) + ")")
                .call(xAxis);


            var colorFn = d3.scaleOrdinal().domain(["Africa", "Europe", "Oceania", "Asia", "Americas"]).range([0, 250]);
            /* Code below relevant for annotations */
            const annotations = [{
                    note: {
                        label: "Europe Launch"
                    },
                    className: "europe",
                    subject: {
                        y1: margin.top + 150,
                        y2: height - margin.bottom
                    },
                    y: margin.top + 150,
                    data: {
                        x: "04/01/1989"
                    } //position the x based on an x scale


                }, {
                    note: {
                        label: "Asia Launch"
                    },
                    className: "asia",
                    subject: {
                        y1: margin.top + 80,
                        y2: height - margin.bottom
                    },
                    y: margin.top + 80,
                    data: {
                        x: "11/01/1991"
                    }
                }, {
                    note: {
                        label: "Africa Launch"
                    },
                    className: "africa",
                    subject: {
                        y1: margin.top + 90,
                        y2: height - margin.bottom
                    },
                    y: margin.top + 90,
                    data: {
                        x: "10/23/2000"
                    }
                }, {
                    note: {
                        label: "Oceania Launch"
                    },
                    className: "oceania",
                    subject: {
                        y1: margin.top + 30,
                        y2: height - margin.bottom
                    },
                    y: margin.top + 30,
                    data: {
                        x: "10/23/2010"
                    }
                }, {
                    note: {
                        label: "Recession",
                        lineType: "none",
                        orientation: "leftRight",
                        "align": "middle"
                    },
                    className: "anomaly",
                    type: d3.annotationCalloutCircle,
                    subject: {
                        radius: 25
                    },
                    data: {
                        x: "6/21/2007",
                        y: 61000
                    },
                    dx: 40,
                    y: margin.top + 150
                }, {
                    note: {
                        label: "0.2M clients",
                        wrap: 100,
                    },
                    className: "above",
                    disable: ["connector"],
                    subject: {
                        x1: x(new Date('02/1/2013')),
                        x2: x(new Date('8/1/2014'))
                    },
                    x: x(new Date('10/1/2014')),
                    dx: 50,
                    data: {
                        y: 200000
                    }
                }

            ]
            const type = d3.annotationCustomType(
                d3.annotationXYThreshold, {
                    "note": {
                        "lineType": "none",
                        "orientation": "top",
                        "align": "middle"

                    }
                }
            )

            const makeAnnotations = d3.annotation()
                .type(type)
                .accessors({
                    x: function(d) {
                        return x(new Date(d.x))
                    },
                    y: function(d) {
                        return y(d.y)
                    }
                })
                .annotations(annotations)
                .textWrap(20)



            svgLineChart
                .append("g")
                .call(makeAnnotations);


        });

        //----Divided line code  ----
        //https://bl.ocks.org/emeeks/03396c05b39b8198685f3e46942c87e3
        const dividedLine = (parameters, points, searchIterations) => {
            let currentParameters = parameters(points[0], 0)
            let currentPointsArray = []
            let dividedLinesData = [{
                key: currentParameters,
                points: currentPointsArray
            }]
            points.forEach((point, pointI) => {

                const newParameters = parameters(point, pointI)
                let matchingParams = newParameters === currentParameters;

                if (typeof currentParameters === "object") {
                    matchingParams = JSON.stringify(newParameters) === JSON.stringify(currentParameters)
                }

                if (matchingParams) {
                    currentPointsArray.push(point)
                } else {
                    const lastPoint = currentPointsArray[currentPointsArray.length - 1];
                    let pointA = lastPoint;
                    let pointB = point;

                    for (let x = 0; x < searchIterations; x++) {
                        const keys = Object.keys(pointA)
                        const findPoints = simpleSearchFunction(pointA, pointB, currentParameters, parameters, keys)
                        pointA = findPoints[0]
                        pointB = findPoints[1]
                    }
                    currentPointsArray.push(pointB)
                    currentPointsArray = [pointB, point]
                    dividedLinesData.push({
                        key: newParameters,
                        points: currentPointsArray
                    })
                    currentParameters = newParameters
                }
            })
            return dividedLinesData
        }

        function simpleSearchFunction(pointA, pointB, current, parameters, keys) {
            const betweenPoint = {};
            keys.forEach(key => {
                betweenPoint[key] = typeof pointA[key] === "number" ? (pointA[key] + pointB[key]) / 2 : pointB[key]
            })

            if (JSON.stringify(parameters(betweenPoint)) === JSON.stringify(current)) {
                return [betweenPoint, pointB]
            }
            return [pointA, betweenPoint]
        }

        function parameters(point) {
            const steve = new Date("7/9/1997")
            if (new Date(point.Date) < steve) {
                return "before"
            }
            if (point.Close > 100) {
                return "top"
            }
            return "normal"
        }

        var styleMap = {
            before: {
                "stroke-dasharray": '1, 2'
            },
            top: {
                "stroke": "#00BFA5"
            },
            normal: {}
        }
    </script>
</body>

</html>